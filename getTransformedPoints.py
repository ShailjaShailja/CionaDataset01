import numpy as np
from tifffile import imread, imsave, imshow
import matplotlib.pyplot as plt
from matplotlib.patches import Circle

src="Box5-A1-27-01-11500.tif" 
imag_mag = 0.00284108
points=[[-4.04726,7.34831],[-5.07632,6.08524],[-5.26032,5.73964],[-5.3344,5.3493],[-5.41703,5.27782],[-5.47239,5.0901],[-5.60103,4.93222],[-5.68366,4.86074],[-5.73902,4.67302],[-6.03293,4.37217],[-6.43754,3.69589],[-6.62153,3.3503],[-6.73306,2.5547],[-6.88041,2.19419],[-6.87654,1.82468],[-6.7074,1.59814],[-6.64348,1.46699],[-6.68092,1.06174],[-6.69964,0.85912],[-6.61313,0.561086],[-6.60925,0.191578],[-6.43623,-0.404472],[-6.18058,-0.929043],[-6.11666,-1.06019],[-5.86488,-1.21524],[-5.861,-1.58475],[-5.87036,-1.68606],[-5.65989,-1.87686],[-5.51334,-1.93652],[-5.38552,-2.19881],[-4.54366,-2.962],[-4.16405,-3.37934],[-3.70181,-3.72519],[-3.32221,-4.14254],[-2.31509,-4.76276],[-1.10139,-5.20427],[-0.0528759,-5.78878],[1.16083,-6.23029],[1.74702,-6.46892],[2.25058,-6.77903],[3.42297,-7.25629],[4.0918,-7.42343],[4.42622,-7.507],[4.57277,-7.56666],[6.36492,-7.50777],[7.1577,-7.56769],[7.57475,-7.57978],[8.5742,-7.461],[9.69752,-7.23498],[10.2845,-7.05343],[10.7616,-6.82715],[10.8809,-6.77059],[10.9362,-6.58287],[10.6844,-6.42781],[10.5566,-6.16552],[10.4249,-5.53373],[10.3384,-5.23571],[10.2651,-5.20588],[10.2613,-4.83636],[10.1334,-4.57408],[10.1108,-4.4072],[10.0376,-4.37737],[10.015,-4.21049],[9.8045,-4.01969],[9.69927,-3.92429],[9.62599,-3.89446],[9.6034,-3.72758],[9.2238,-3.31024],[9.13729,-3.01221],[9.03206,-2.91681],[8.94555,-2.61879],[8.7764,-2.39225],[8.6899,-2.09422],[8.52068,-1.86765],[8.34766,-1.2716],[8.30247,-0.937835],[8.0055,-0.449011],[7.79117,0.111297],[7.68593,0.206696],[7.59943,0.504721],[7.52615,0.53455],[7.50356,0.701433],[7.29309,0.892232],[7.20659,1.19026],[7.14267,1.3214],[6.84958,1.44071],[6.42865,1.82231],[6.09036,2.27539],[5.94381,2.33504],[5.77468,2.56159],[5.5229,2.71665],[5.37635,2.7763],[5.2072,3.00284],[5.13393,3.03267],[5.08486,3.73594],[5.19558,4.11137],[5.20023,4.16204],[5.14103,4.34383],[5.12856,5.0322],[5.04206,5.33023],[5.06078,5.53286],[5.07014,5.63417],[5.03347,5.6491],[4.93295,5.79514],[4.7864,5.85479],[4.7638,6.02168],[4.65857,6.11708],[4.28283,6.16491],[4.09496,6.18883],[3.98037,6.18291],[3.95778,6.3498],[4.25169,6.65065],[4.47472,8.24184],[4.69535,8.57252],[5.0259,8.85846],[5.24652,9.18914],[5.32141,9.99965],[5.21618,10.095],[4.84044,10.1429],[4.56526,10.0447],[4.12481,9.80345],[3.62511,9.74406],[3.20806,9.75614],[3.0202,9.78006],[1.93818,9.58978],[0.874086,9.18196],[0.374394,9.12256],[-0.748933,8.89654],[-1.84967,8.50363],[-2.84049,8.06598],[-3.75803,7.59851],[-3.92331,7.45553],[-4.00594,7.38405],[17.0966,-1.71959],[16.8226,-1.95657],[16.5797,-1.85769],[16.8194,-1.65034],[16.8233,-1.60836],[16.5151,-1.87497],[16.8188,-1.99857],[17.1612,-1.70235],[16.8576,-1.57874],[16.8537,-1.62071],[5.59539,11.208],[5.58302,11.0738],[5.6314,10.9744],[5.619,10.8402],[5.58417,10.7748],[5.57708,10.6981],[5.68806,10.6529],[5.74354,10.6303],[5.91708,10.6392],[6.13755,10.6888],[6.30432,10.7801],[6.42947,10.8884],[6.62427,11.1275],[6.73554,11.2414],[6.81202,11.2899],[6.81554,11.3282],[6.87807,11.3823],[6.91294,11.4478],[6.91646,11.4861],[6.78991,11.5178],[6.47966,12.6194],[6.45874,12.5484],[6.3336,12.4402],[6.24325,12.3973],[6.18072,12.3432],[6.21348,12.2304],[6.20988,12.192],[6.0986,12.0781],[6.06382,12.0127],[5.98734,11.9642],[5.87607,11.8503],[5.87074,11.7927],[5.93485,11.707],[5.9434,11.6438],[6.00743,11.558],[6.0402,11.4452],[6.22937,11.4677],[6.33179,11.4857],[6.47403,11.4676],[6.69447,11.5171],[6.88897,11.5971],[7.02798,11.6997],[7.09059,11.7539],[7.11713,12.0415],[7.12958,12.1758],[7.25473,12.2841],[7.29484,12.407],[7.39224,12.5266],[7.42711,12.592],[7.3474,12.6642],[7.27625,12.6733],[7.23644,12.7094],[7.24356,12.7862],[7.02162,12.8765],[6.95046,12.8855],[6.84804,12.8675],[6.68128,12.7762],[6.54227,12.6736],[6.49533,12.633],[6.56758,11.449],[6.18923,11.4041],[6.00006,11.3816],[5.91331,11.3771],[5.70494,11.3027],[5.64233,11.2486],[5.61106,11.2215]]
img = imread(src)
img = np.flip(img.T, 1)
imshow(img)

#get inverse transform using the contour transform coefficients
#contour transform
a =[-12.4219340480873,1.02329692936977,0.0547410605730517,0,0,0]
b =[6.70121729036356,-0.345509738706612,0.972479703389782,0,0,0]
from math import *
epsilon = 5e-10;
it_img = np.zeros((10000, 10000))
c_p = []

def Xforward(dim, a, b, x, y):
    if dim == 1:
        return a[0] + x
    elif dim == 2:
        return a[0] + a[1]*x
    elif dim == 3:
        return a[0] + a[1]*x + a[2]*y
    elif dim == 4:
        return a[0] + (a[1] + a[3]*y)*x + a[2]*y
    elif dim == 5:
        return a[0] + (a[1] + a[3]*y + a[4]*x)*x + a[2]*y
    elif dim == 6:
        return a[0] + (a[1] + a[3]*y + a[4]*x)*x + (a[2] + a[5]*y)*y
    return None

def Yforward(dim, a, b, x, y):
    if dim == 1:
        return b[0] + y
    elif dim == 2:
        return b[0] + b[1]*y
    elif dim == 3:
        return b[0] + b[1]*x + b[2]*y
    elif dim == 4:
        return b[0] + (b[1] + b[3]*y)*x + b[2]*y
    elif dim == 5:
        return b[0] + (b[1] + b[3]*y + b[4]*x)*x + b[2]*y
    elif dim == 6:
        return b[0] + (b[1] + b[3]*y + b[4]*x)*x + (b[2] + b[5]*y)*y
    return None

for i in points:
    dim = 6
    x = i[0]
    y = i[1]
    u = x
    v = y
    x0 = 0.0           #initial guess of (x,y)
    y0 = 0.0
    u0 = Xforward(dim, a, b, x0,y0)          #get forward tform of initial guess
    v0 = Yforward(dim, a, b, x0,y0)
    i = 0
    e = 1.0
    while (e > epsilon) and (i < 10):
        i += 1
        l = a[1] + a[3]*y0 + 2.0*a[4]*x0
        m = a[2] + a[3]*x0 + 2.0*a[5]*y0
        n = b[1] + b[3]*y0 + 2.0*b[4]*x0
        o = b[2] + b[3]*x0 + 2.0*b[5]*y0
        p = l*o - m*n
        if abs(p) > epsilon:
            x0 += (o*(u-u0) - m*(v-v0))/p
            y0 += (l*(v-v0) - n*(u-u0))/p
        else:
            x0 += l*(u-u0) + n*(v-v0)
            y0 += m*(u-u0) + o*(v-v0)
        u0 = Xforward(dim, a, b, x0,y0)
        v0 = Yforward(dim, a, b, x0,y0)
        e = abs(u-u0) + abs(v-v0)
    result_x = x0
    result_y = y0
    c_p.append([result_x,result_y])
#get the forward transform using the image transform coefficients
#image transform
a= [ 7.06307051846487, 0.0288393061798161, -0.365741635336368,0,0,0]
b = [-0.356472580116627,0.330871689624869, -0.284621855197495, 0, 0, 0]
i_p = []
for i in c_p:
    x = i[0]
    y = i[1]
    result_x = a[0] + (a[1] + a[3]*y + a[4]*x)*x + (a[2] + a[5]*y)*y
    result_y = b[0] + (b[1] + b[3]*y + b[4]*x)*x + (b[2] + b[5]*y)*y
    i_p.append([result_x,result_y])

fig,ax = plt.subplots(1)
ax.set_aspect('equal')
ax.imshow(img)
for i in i_p:
    # print(round(i[1]/imag_mag), round(i[0]/imag_mag))
    circ = Circle((round(i[1]/imag_mag), round(i[0]/imag_mag)),20, color='r')
    ax.add_patch(circ)
plt.show()

